<template>
  <page :pageClasses="['post_new_steemgig__view', 'row']">
    <el-main>
      <h3>Create new {{capitalize(getSubCategoryName.name)}}</h3>
      <h5 v-text="getSubCategoryName.description" />
      <div class="form-container">
        <el-form :model="newGigRequest" :rules="testimonialRules" ref="newGigRequest" label-position="top">
          <!--  Title -->
          <el-form-item label="Title" prop="title">
            <el-input v-model="newGigRequest.title"></el-input>
          </el-form-item>
          <!-- Category -->
          <el-row :gutter="15">
            <el-col :xs="24" :sm="24" :md="12" :lg="12" :xl="12">
              <el-form-item label="Category" prop="category">
                <select class="browser-default my-select category_select" @change="refreshSubCategory" v-model="newGigRequest.category">
                  <option value="" disabled selected>Select Category</option>
                  <option v-if="category.name != 'SurpassingGoogle'" v-for="(category, index) in categories" :key="index" :value="category.name" v-text="category.name"></option>
                  </select>
              </el-form-item>
            </el-col>
            <!-- Sub Category -->
            <el-col :xs="24" :sm="24" :md="12" :lg="12" :xl="12">
              <el-form-item label="Sub Category" prop="subCategory">
                <select :disabled='this.newGigRequest.category.length === 0' class="my-select browser-default subCategory_select" v-model="newGigRequest.subcategory">
                  <option value="" disabled selected>Select Subcategory</option>
                  <option v-for="(subcategory, index) in categories[selectedCategoryIndex].subcategories" :key="index" :value="subcategory.name" v-text="subcategory.name"></option>
                  </select>
              </el-form-item>
            </el-col>
          </el-row>
          <!-- Body -->
          <el-form-item label="Description" prop="description">
            <vue-editor v-model="newGigRequest.description" placeholder="Type your post here" :upload="uploadConfig" />
          </el-form-item>
          <!-- Tags -->
          <el-form-item label="Tags" prop="tags">
            <!-- Fixed Tags -->
            <el-tag v-for="(tag, index) in defaultTags" :key="index">{{ tag }}</el-tag>
            <!-- Dynamic Tags -->
            <el-tag v-for="(userTag, index) in userTags" :key="index" closable> {{ userTag }} </el-tag>
            <el-input class="input-new-tag" v-if="inputVisible" v-model="inputValue" ref="saveTagInput" size="mini" @keyup.enter.native="handleInputConfirm" @blur="handleInputConfirm" />
            <el-button v-else-if="userTags.length < 5 - defaultTags.length" class="button-new-tag" size="small" @click="showInput">+ New Tag</el-button>
          </el-form-item>
          <!-- Form Submission -->
          <el-form-item>
            <el-button type="primary" @click="submitForm('newTestimonial')">Create</el-button>
            <el-button @click="resetForm('newTestimonial')">Reset</el-button>
          </el-form-item>
        </el-form>
      </div>
    </el-main>
  </page>
</template>

<script>
import axios from '@/plugins/axios'
import Api from '@/services/api'
import Page from '@/components/page'
import CatNav from '@/components/layout/catNav'
import ImgUpload from '@/components/snippets/imgUpload'
import { MarkdownEditor } from 'markdown-it-editor'
import VueMarkdown from 'vue-markdown'
import { VueEditor } from 'vue2-editor'
import form from '@/mixins/form.js'

export default {
  mixins: [form],
  components: {
    Page,
    CatNav,
    MarkdownEditor,
    VueMarkdown,
    ImgUpload,
    VueEditor
  },
  data () {
    return {
      totalPics: 1,
      portfolioImages: [],
      PageDescription: '',
      newGigRequest: {
        title: '',
        category: '',
        subcategory: '',
        description: '',
        hours: 0,
        days: 0,
        currency: 'STEEM',
        images: [],
        reward: '100% STEEM POWER',
        price: 0,
        liked: false,
        upvoteRange: 100
      },
      customToolbar: [
        ['bold', 'italic', 'underline'],
        [{
          'list': 'ordered'
        }, {
          'list': 'bullet'
        }],
        ['image', 'code-block']
      ],
      uploadConfig: {
        name: 'file',
        accept: 'image/jpg,image/jpeg,image/png',
        url: this.$imgUploadURL
      }
    }
  },
  methods: {
    handleImageAdded (file, Editor, cursorLocation) {
      const CLIENT_ID = '993793b1d8d3e2e'
      var formData = new FormData()
      formData.append('image', file)

      axios({
        url: 'https://api.imgur.com/3/image',
        method: 'POST',
        headers: {
          'Authorization': 'Client-ID ' + CLIENT_ID
        },
        data: formData
      })
        .then((result) => {
          console.log(result)
          let url = result.data.data.link
          Editor.insertEmbed(cursorLocation, 'image', url)
          this.portfolioImages.push(url)
          // this.newGigRequest.portfolio = this.portfolioImages
        })
        .catch((err) => {
          console.log(err)
        })
    },
    refreshSubCategory () {
      this.newGigRequest.subcategory = ''
    },
    morePics () {
      if (this.totalPics < 4) this.totalPics++
    },
    getTags (entries) {
      this.userTags = entries
    },
    trypics () {
      console.log(this.newGigRequest.portfolio)
    },
    submit () {
      if (!this.errorr) {
        if (this.isPosting) return
        let that = this
        this.errorText = ''
        this.successText = ''
        this.isPosting = true
        this.isPosting = true
        let jsonMetadata = {
          app: 'steemgig',
          tags: [...this.userTags, ...this.defaultTags],
          format: 'Markdown',
          timestamp: new Date().getTime(),
          price: 0,
          currency: 'SBD',
          authorPic: this.$store.state.profile.profileImage,
          category: 'surpassinggoogle',
          subcategory: this.slugify(this.$route.params.subcategory),
          type: 'steemgigs_surpassinggoogle',
          deleted: true,
          images: this.portfolioImages,
          generated: true
        }
        let username = this.$store.state.username
        let permlink = this.slugify(this.newGigRequest.title)
        let steemLink = this.htmlHide(`Visit <a href="https://steemgigs.org">https://steemgigs.org</a> now, to use it for free<br  />`)
        let steemGigsTag = this.htmlHide(`
      <i>this post was made on <a href="https://steemgigs.org/@${username}/${permlink}">STEEMGIGS Where everyone has something to offer</a></i>
            `)
        let body = this.previewData + steemLink + steemGigsTag
        let token = this.$store.state.accessToken
        let title = this.steemedTitle
        if (this.duplicateTitle) {
          let modifiedTitle = this.newGigRequest.title + Math.floor(Math.random() * 1000)
          permlink = this.slugify(modifiedTitle)
          title = '#STEEMGIGS: ' + '(' + this.getSubCategoryName.name + ') — ' + modifiedTitle.replace('#STEEMGIGS:', ' ') // this will prevent title for not showing on the gigcard due to duplicated '#STEEMGIGS:' string
        }
        let liked = this.newGigRequest.liked
        let upvoteRange = this.newGigRequest.upvoteRange
        // sc2.setAccessToken(this.$store.state.accessToken)
        Api.post({
          username,
          permlink,
          title,
          body,
          jsonMetadata,
          liked,
          upvoteRange
        }, token).then((err, res) => {
          console.log(err, res)
          that.isPosting = false
          this.$notify({
            group: 'foo',
            title: 'Success',
            text: 'Successfully pushed to steem!',
            type: 'success'
          })
          that.successText = 'Successfully pushed to steem!'
          that.$store.commit('RESET_NEW_SURPASSINGGOOGLE')
        }).catch((e) => {
          that.isPosting = false
          this.$notify({
            group: 'foo',
            title: 'Error',
            text: 'Error pushing post to steem.',
            type: 'error'
          })
          that.errorText = 'Error pushing post to steem.'
        })
      }
    }
  },
  computed: {
    getSubCategoryName () {
      var PageName = ''
      this.categories[4].subcategories.forEach((sub, index) => {
        if (this.slugify(sub.name) === this.$route.params.subcategory) {
          PageName = sub
        }
      })
      return PageName
    },
    selectedCategoryIndex () {
      let catIndex = 0
      this.categories.forEach((category, index) => {
        if (category.name === this.newGigRequest.category) catIndex = index
      })
      return catIndex
    },
    wordCount () {
      if (this.newGigRequest.title.length > 0) {} else {
        return `90 Characters`
      }
    },
    steemedTitle () {
      return '#STEEMGIGS: ' + '(' + this.getSubCategoryName.name + ') — ' + this.newGigRequest.title
    },
    defaultTags () {
      let tags = ['steemgigs', 'surpassinggoogle', this.slugify(this.$route.params.subcategory)]
      if (this.newGigRequest.category) {
        tags.push(this.newGigRequest.category)
      }
      if (this.newGigRequest.subcategory) {
        tags.push(this.newGigRequest.subcategory)
      }
      return tags
    },
    previewData () {
      return `
    ${this.newGigRequest.description}
          `
    }
  },
  mounted () {
    this.$eventBus.$on('img-uploaded', payload => {
      console.log(payload)
      this.newGigRequest.portfolio[payload.index] = payload.url
    })
  },
  deforeDestroy () {
    this.$eventBus.$off('img-uploaded')
  }
}
</script>

<style lang="scss" scoped>
  .form-container {
    background: white;
    padding: 20px;
  }
</style>
